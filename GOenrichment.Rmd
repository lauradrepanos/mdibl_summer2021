

---
output: 
  html_document:
params: 
  experiment_name: "jcoffman008"
  treatment: "klf9-knockout"
  filepath_deseq: "jcoffman_008.klf9_multiTime_2021_merged_nogeneduplicates_PC1_time.DESeq2_out.tsv"
title: "Enriched GO groups among genes upregulated by `r params$treatment` in `r params$experiment_name`"

---


```{r setup,echo=FALSE,include=FALSE}
#R -e "rmarkdown::render('GOenrichment.Rmd')"
#Work in progress!!! Currently the main feature is that it writes the csv... 

if (!requireNamespace("BiocManager", quietly = TRUE)){
  install.packages("BiocManager")
}
if (!requireNamespace("clusterProfiler", quietly = TRUE)){
  BiocManager::install("clusterProfiler")
}
#gene enrichment requires zebrafish database
if (!requireNamespace("org.Dr.eg.db", quietly = TRUE)){
	BiocManager::install("org.Dr.eg.db", character.only = TRUE)
}

library(clusterProfiler)
library(ggplot2)
library(tidyr)
library(rmarkdown)
library("org.Dr.eg.db", character.only = TRUE)



#read deseq output file
DESeq2_out <- read.delim(params$filepath_deseq)

#separate GeneID from name so that fold change can be associated with one or the other (instead of GeneID_genename)
DESeq2_out<- separate(data = DESeq2_out, col = X, into = c("GeneID", "GeneName"), sep = "\\_")

#filter out low counts and insignificant p values
DESeq2_out <- subset(DESeq2_out,baseMean>100)
DESeq2_out <- subset(DESeq2_out,padj<0.05)

#prepare ranked list
fold_changes <- DESeq2_out$log2FoldChange
names(fold_changes) <- DESeq2_out$GeneName

#need to remove NAs first 
fold_changes <- na.omit(fold_changes)

#sorting fold changes from high to low
fold_changes <- sort(fold_changes, decreasing= TRUE)


GOresults <- gseGO(geneList= fold_changes, 
                   keyType = "GENENAME", 
                   minGSSize = 3, 
                   maxGSSize = 800, 
                   nPerm = 500,
                   pvalueCutoff = 1, 
                   OrgDb = get("org.Dr.eg.db"), 
                   pAdjustMethod = "BH")

write.csv(GOresults,paste("GOresults_",params$experiment_name,".csv",sep=""),row.names = FALSE)
summarized_GOresults <- GOresults[c(1:30),c("ID","Description","core_enrichment")]

##figure out how to show the summarized_GOresults on the html!!!!
```

